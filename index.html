<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8" /> 
<title>Flatorize</title>
<link rel="stylesheet" type="text/css" href="prettify/prettify.css">
<link rel="stylesheet" type="text/css" href="flatorize.css">
<script type="text/javascript" src="log.js"></script>
<script type="text/javascript" src="flatorize.js"></script>
<script type="text/javascript" src="examples.js"></script>
<script type="text/javascript">generate_small_functions();</script>
</head>
<body>

<ul class="screen-hidden">
  <li>github: <a href="https://github.com/glathoud/flatorize">https://github.com/glathoud/flatorize</a></li>
  <li>[1] <a href="http://glat.info">http://glat.info</a></li>
  <li>[2] <a href="http://asmjs.org">http://asmjs.org</a></li>
</ul>
<a href="https://github.com/glathoud/flatorize" class="print-hidden">
  <img style="position: fixed; top: 0; right: 0; border: 0; margin: 0; padding: 0;"
       src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
       alt="Fork me on GitHub">
</a>

<h2>Flatorize: Generate fast, flat, factorized code for mathematical expressions</h2>

<p style="text-align:right">by <a href="http://glat.info">Guillaume Lathoud</a><span class="print">&nbsp;[1]</span>, April 2013</p>

<h3 class="anchorable" id="tldr">TL;DR <a href="#tldr" class="anchor">#</a></h3>

<p><code>flatorize</code> generates fast JavaScript code for mathematical expressions.</p>

<p>Speedups exceed +1000% in many cases, including matrix multiplication and the Discrete Fourier Transform (<a href="#push-all">full results</a>).</p>

<p>A plugin permits to generate fast C code as well (<a href="c_code.html">examples</a>).</p></ul>

<h3 class="anchorable" id="summary">Summary <a href="#summary" class="anchor">#</a></h3>

<p>Writing or generating code for mathematical
expressions, one can end up with things like:</p>

<pre class="prettyprint lang-js"><code>function f(a,b,c) { return sub( sub(a,add(b,c)), add(b,c) ); }
</code></pre>

<p><em>Writing</em> many small functions like <code>add</code>
and <code>sub</code> permits to prevent bugs, and think
in a clearer way, but <em>at runtime</em> it costs function overhead.</p>

<p>Here I propose to speed up math computations by generating code where function overhead has been eliminated.

The two core ideas are to <a href="#factorize">factorize</a> and to <a href="#flatten">flatten</a> the implementation of mathematical expressions, hence the name <code>flatorize</code>.</p>

<p>A JavaScript <a href="#impl">implementation</a> is provided. <a href="#push-all">Test&nbsp;results</a> show huge speedups, including on recursive expressions (e.g.&nbsp;Cooley-Tukey expression of the Discrete Fourier Transform).</p>

<p>Initial tests show huge speedups in <a href="https://github.com/glathoud/flatorize/blob/master/explore/scheme/dftreal16/dftreal16.results.txt#L66">Scheme</a> and <a href="https://github.com/glathoud/flatorize/blob/master/explore/C/cAll_matmul.results.txt#L40">C</a> as well.</p>

<!--pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(f2.getDirect()+'')</script></code></pre>
<p class="small">(This code, as a few others below, was produced and inserted as you loaded the page.)</p-->


<h3 class="anchorable" id="factorize">Factorize <a href="#factorize" class="anchor">#</a></h3>

<p>To spare CPU, one can modify  the above example by evaluating <code class="prettyprint lang-js">add(b,c)</code>
 only once:</p>
<pre class="prettyprint lang-js"><code>function f(a,b,c) { 
    var bc = add(b,c);
    return sub( sub(a,bc), bc ); 
}
</code></pre>

<h3 class="anchorable" id="flatten">Flatten <a href="#flatten" class="anchor">#</a></h3>

<p>Small "building block" functions like <code class="prettyprint
lang-js">add</code> or <code class="prettyprint
lang-js">sub</code> are useful to <em>write</em> code, but <em>at runtime</em> the
CPU spends more time in function overhead than just doing the simple operation(s) in them.<p>

<p>In more complex cases like recursive expressions, the function overhead becomes even bigger.</p>

<p>One can eliminate function overhead by inlining each small function, that&nbsp;is&nbsp;replacing each small function with its implementation:</p>
<pre class="prettyprint lang-js"><code>function f(a,b,c) { 
    var bc = b+c;
    return (a - bc) - bc;
}
</code></pre>

<p>The CPU performance should be pretty good at this point.</p>

<p>One could try to further optimize,
e.g. writing <code class="prettify lang-js">a-2*bc</code>, which
amounts to mathematical expression simplification. This can be quite
complicated, and it is not sure how much CPU speed can be gained this
way -&nbsp;especially compared to function overhead elimination&nbsp;-
so if we ever attempt simplification, we'll keep it very simple.
</p>

<h3 class="anchorable" id="impl">Implementation <a href="#impl" class="anchor">#</a></h3>

<p>An implementation called <code>flatorize</code> is provided that generates fast code for mathematical expressions, using factorization and flattening.</p>

<p><code>flatorize</code> source files: on <a href="https://github.com/glathoud/flatorize">github</a>, or here (<a href="flatorize.js">flatorize.js</a>, <a href="examples.js">examples.js</a>, <a href="log.js">log.js</a>).</p>

<p>The rest of this article describes how to use <code>flatorize</code>, then gives
several performance results &ndash; pushing things until they
break.</p>



<h3 class="anchorable" id="usage">Usage: <code>expr</code>, <code>part</code> and <code>flatorize</code> <a href="#usage" class="anchor">#</a></h3>

<p>
<code class="prettyprint lang-js">flatorize('a,b,c', function f(a,b,c) { ... })</code> returns a new function, obtained by:
  <ol>
    <li>calling <code class="prettyprint lang-js">f('a','b','c')</code>, which returns an expression,</li>
    <li>factorizing and flattening the expression,</li> 
    <li>generating the new code for the expression.</li>
  </ol>
</p>

<p><code class="prettyprint lang-js">f(a,b,c)</code> can use 3&nbsp;ways to build and return an expression:</p>
<ul>
<li><code class="prettyprint lang-js">flatorize.expr(a,'+',b)</code> defines the code expression <code class="prettyprint lang-js">a+b</code>.</li>
<li><code class="prettyprint lang-js">flatorize.part(arr,3)</code> or <code class="prettyprint lang-js">flatorize.part(obj,'prop')</code> describe the extraction of a property value from an object (array or not).</li>
<li><code class="prettyprint lang-js">[ 'a', anExpr ]</code> is an array expression composed of 2 sub-expressions.</li>
</ul>

<h3 class="anchorable" id="example">Example: complex numbers <a href="#example" class="anchor">#</a></h3>

<p>We now work with complex numbers, which we represent as arrays of two numbers <code class="prettyprint lang-js">[re,im]</code>. Consider the function <code>f</code> of complex numbers <code class="prettyprint lang-js">a,b,c</code>:</p>

<pre class="prettyprint lang-js"><code>f = <script type="text/javascript">document.write(f+'')</script>;</code></pre>

<p>To produce an optimized implementation <code>f2</code> of the function <code>f</code>,
we use <a href="flatorize.js">flatorize</a> and write the following code:</p>

<pre class="prettyprint lang-js"><code>FZ    = flatorize;
cadd  = FZ('a,b',   function (a,b)   { 
    return cplx( FZ.expr( creal(a), '+', creal(b) ),
                 FZ.expr( cimag(a), '+', cimag(b) ) 
               ); 
});
csub  = FZ('a,b',   function (a,b)   { 
    return cplx( FZ.expr( creal(a), '-', creal(b) ),
                 FZ.expr( cimag(a), '-', cimag(b) ) 
               ); 
});
creal = FZ('a',     function (a)     { return FZ.part( a, 0 ); });
cimag = FZ('a',     function (a)     { return FZ.part( a, 1 ); });
cplx  = FZ('re,im', function (re,im) { return [ re, im ]; });

f  = <script type="text/javascript">document.write(f+'');</script>
f2 = FZ('a,b,c',f);
</code></pre>

<p>All functions returned by <code class="prettyprint lang-js">flatorize</code>
can be used to build further expressions: in the above example, <code>creal</code> is used to express <code>cadd</code>, which itself is used to expressed <code>f</code>. Definition order does not matter.
</p>

<p>All functions returned by <code class="prettyprint lang-js">flatorize</code>
can also be called with values, for computation. For example, calling <code class="prettyprint lang-js">f2(a,b,c)</code> executes
the flat, factorized:</p>

<pre class="prettyprint lang-js" id="example-generated"><code><script type="text/javascript">document.write(f2.getDirect()+'')</script></code></pre>
<p class="small">(This code, as a few others below, was produced and inserted as you loaded the page.)</p>












<h3 class="anchorable" id="matmulrows">Example: matrix multiplication (arrays of rows)<a href="#matmulrows" class="anchor">#</a></h3>

<p>Consider matrices expressed as 2-dimensional arrays of rows. Here is an implementation of matrix multiplication using 3 nested loops:</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">function matmulrows_loops( a, b )
{
  var nrow = a.length
  ,   ncol = b[ 0 ].length
  ,   ret  = new Array( nrow )
  ,   nrow_b = b.length
  ;
  for (var ir = 0; ir < nrow; ir++)
  {
    var ra = a[ ir ]
    ,   rr = ret[ ir ] = new Array( ncol )
    ;
    for (var ic = 0; ic < ncol; ic++)
    {
      var x = 0;
      for (var irb = 0; irb < nrow_b; irb++)
      {
         x += ra[ irb ] * b[ irb ][ ic ];
      }
      rr[ ic ] = x;
    }
  }
  return ret;
}
</script><script type="text/javascript">document.write(matmulrows_loops+'')</script>  

// Does this work?

<script type="text/javascript" id="matmulrows_loops_test_script">a = [ [1,2,3,4], [5,6,7,8], [9,10,11,12] ];
b = [ [13,14], [15,16], [17,18], [19,20] ];
c = matmulrows_loops( a, b );
</script><script type="text/javascript">document.write(document.getElementById('matmulrows_loops_test_script').textContent + '\n// c: ' + JSON.stringify( c ));</script>  // Yes!  </pre>

<p>Guessing the intent of <code>matmulrows_loops</code> from its implementation alone can be hard. Concepts are <em>not</em> encapsulated into separate functions, which slows down understanding, debugging and maintenance.</p>


<p>Can we express the concept of matrix multiplication in a more concise and better encapsulated way? For example, in Python:</p>
<pre class="prettyprint lang-python"><code># Python

a = [ [1,2,3,4,], [5,6,7,8,], [9,10,11,12,], ]
b = [ [13,14,], [15,16,], [17,18,], [19,20,]]

c = map(lambda ra: map(lambda cb: sum(x*y for x,y in zip(ra,cb)), zip(*b)),a)

# or expressed using list comprehension:

c = [[ sum(x*y for x,y in zip(ra,cb)) for cb in zip(*b) ] for ra in a ]

# in both cases zip(*b) implements the "transposed matrix"

# result:
# >>> c
# [[170, 180], [426, 452], [682, 724]]
</code></pre>
<p>The expression is concise, shorter than the nested loops used above, and the various concepts are well encapsulated: <code>map</code>, <code>sum</code> and <code>zip(*b)</code>. The reference to rows of <code>a</code> and columns of <code>b</code> is <em>explicit</em> through variables <code>ra</code>&nbsp;and&nbsp;<code>cb</code>, respectively. This can facilitate understanding.</p>

<p>A similar implementation in JavaScript requires to define <code>zip</code> and <code>sum</code>:</p>
<pre class="prettyprint lang-js"><script type="text/javascript" id="matmulrows_zip_script">// JavaScript

function matmulrows_zip( a, b )
{
  return a.map( function (ra) { 
    return zip.apply( null, b ).map( function (cb) {
      return sum( 
        zip( ra, cb )
          .map( function (xy) { return xy[ 0 ] * xy[ 1 ]; } )
      );
    } );
  } );
}

// Tools

function zip(/*...arguments...*/)
{
  var arg = [].slice.apply( arguments );
  if (!arg.length)
    return [];
 
  var n = arg[ 0 ].length
  , ret = new Array( n )
  ;
  for (var i = 0; i < n; i++)
    ret[ i ] = arg.map( function (x) { return x[i]; } );
  
  return ret;
}

function sum( a ) 
{ 
  return a.reduce( function (c,d) { return c + d; }, 0 ); 
}
</script><script type="text/javascript">document.write(document.getElementById('matmulrows_zip_script').textContent);</script>

// Does this work?

<script type="text/javascript" id="matmulrows_zip_test_script">a = [ [1,2,3,4], [5,6,7,8], [9,10,11,12] ];
b = [ [13,14], [15,16], [17,18], [19,20] ];
c = matmulrows_zip( a, b );
</script><script type="text/javascript">document.write(document.getElementById('matmulrows_zip_test_script').textContent + '\n// c: ' + JSON.stringify( c ));</script>  // Yes!  </pre>

<p>Great! But given the number of nested function calls involved, <code>matmulrows_zip</code> may well run much slower than <code>matmulrows_loops</code>:</p>

<p><button id="tryit_speed_matmulrows_zip" onclick="tryit_speed_matmulrows_zip( this )">Measure the speed!</button> (Feel free to do it multiple times.)</p><pre id="tryit_speed_matmulrows_zip_output">(The speed measurement can last long in some browsers.)</pre>
<p>Example of result:</p>
<pre>   Classic matrix rows multip.: 1.72e+6 matmulrows_loops(a,b) calls per second
   ZIP     matrix rows multip.: 3.43e+4 matmulrows_zip(a,b) calls per second
-> relative speedup: -98%
</pre>

<p>So we have a fast but hard-to-read <code>matmulrows_loops</code>, and a concise, readable, well encapsulated but slow <code>matmulrows_zip</code>:

<pre class="prettyprint lang-js"><script type="text/javascript">document.write(matmulrows_zip)+''</script></pre>

<p>Can we keep the nice encapsulations in <code>matmulrows_zip</code> *and* speed it up? Let us try to write similar code, using <code>flatorize</code>: instead of working on numbers directly, we work on symbols:</p>

<pre class="prettyprint lang-js"><script type="text/javascript" id="matmulrows_zip_flatorize_script">var matmulrows_zip_342 = flatorize( 
  'a,b'
  , function (a,b) { return symbol_matmulrows_zip_gen( a, b, 3, 4, 2 ); } 
);

// Wrapper

function symbol_matmulrows_zip_gen( a, b, I, J, K ) 
{
  // Create matrices of symbolic expressions (NOT numbers)
  var sym_a = symbol_matrixrows( a, I, J )
  ,   sym_b = symbol_matrixrows( b, J, K )
  ;
  // Multiply the symbolic matrices
  return symbol_matmulrows_zip( sym_a, sym_b );
}

// Core

function symbol_matmulrows_zip( a, b )
{
  return a.map( function (ra) { 
    return zip.apply( null, b ).map( function (cb) {
      return symbol_sum( 
        zip( ra, cb )
          .map( function (xy) { return FZ.expr( xy[ 0 ], '*', xy[ 1 ] ); } )
      );
    } );
 } );
}

// Tools

function symbol_matrixrows( name, nrow, ncol )
{
  var ret = new Array( nrow );
  for (var r = 0; r < nrow; r++)
  {
    var row = ret[ r ] = new Array( ncol );
    for (var c = 0; c < ncol; c++)
      row[ c ] = FZ.part( FZ.part( name, r ), c );
  }
  return ret;
}

function symbol_sum( arr )
{
  return FZ.expr.apply( null, arr.reduce( symbol_sum_step, [] ) );
  function symbol_sum_step( left, right ) 
  {
    return left.length  ?  left.concat( [ '+', right ] )  :  [ right ]; 
  }
}
</script><script type="text/javascript">document.write(document.getElementById('matmulrows_zip_flatorize_script').textContent)</script>

// Does this work?

<script type="text/javascript" id="matmulrows_zip_342_test_script">a = [ [1,2,3,4], [5,6,7,8], [9,10,11,12] ];
b = [ [13,14], [15,16], [17,18], [19,20] ];
c = matmulrows_zip_342( a, b );
</script><script type="text/javascript">document.write(document.getElementById('matmulrows_zip_342_test_script').textContent + '\n// c: ' + JSON.stringify( c ));</script>  // Yes!  
</pre>
<p>The core remains very similar. Indeed, compare the number version:</p>

<pre class="prettyprint lang-js"><script type="text/javascript">document.write(matmulrows_zip)</script></pre>

<p>with the new symbolic version:</p>

<pre class="prettyprint lang-js"><script type="text/javascript">document.write(symbol_matmulrows_zip)</script></pre>

<p>All we had to do was to replace:</p>
<ul><li><code>sum</code> with <code>symbol_sum</code></li>
<li><code>xy[ 0 ] * xy[ 1 ]</code> with <code>FZ.expr( xy[ 0 ], '*', xy[ 1 ] )</code></li>
</ul>



<p>Here is the generated implementation:</p>
<pre class="prettyprint lang-js">
<script type="text/javascript">document.write(matmulrows_zip_342.getDirect())</script>
</pre>

<p>Now a look at speed:</p>

<p><button id="tryit_speed_matmulrows_zip_342" onclick="tryit_speed_matmulrows_zip_342( this )">Measure the speed!</button> (Feel free to do it multiple times.)</p><pre id="tryit_speed_matmulrows_zip_342_output">(The speed measurement can last long in some browsers.)</pre>
<p>Example of result:</p>
<pre>   Classic matrix rows multip.: 1.75e+6 matmulrows_loops(a,b) calls per second

   ZIP     matrix rows multip.: 3.55e+4 matmulrows_zip(a,b) calls per second
-> relative speedup compared to "Classic": -98%

   ZIPFLAT matrix rows multip.: 1.75e+6 matmulrows_zip_342(a,b) calls per second
-> relative speedup compared to "Classic": 0%
</pre>

<p><strong>So we can write well-encapsulated code, <code>flatorize</code> it automatically, and the generated code runs as fast as the original nested loops written by hand.</strong> Trade-off: the matrix dimensions must be known to generate the <code>flatorize</code>'d code.</p>







<div style="display:none">xxx Given the previous section, this section would confuse the reader at the moment... I probably need to reformulate this section.
<h3 class="anchorable" id="matmul">Example: matrix multiplication (flat matrices) <a href="#matmul" class="anchor">#</a></h3>

<p>If we know we are going to do some intensive computations,
multiplying matrices of known sizes (3x4 and 4x2 in the example below), we
can use (1)&nbsp;flat matrices, i.e. stored as 1-dimensional arrays of numbers, and (2)&nbsp;<code>flatorize</code> to generate a fast implementation <code>matmul342</code>:</p>

<pre class="prettyprint lang-js"><code>matmul342 = flatorize('a,b', matmul_exprgenF(3,4,2));

<script type="text/javascript">document.write(matmul_exprgenF+'');</script>
</code></pre>

<p>This generates the following function:</p>
<pre class="prettyprint lang-js" id="matmul-generated"><code><script type="text/javascript">document.write(matmul342+'');</script>
</code></pre>

<p>Let us verify that `matmul342` actually works:</p>
<pre class="prettyprint lang-js"><code>mat_a = [ 1,  2,  3, 4, 
          5,  6,  7, 8,
          9, 10, 11, 12
        ];

mat_b = [ 13, 14,
          15, 16,
          17, 18,
          19, 20
        ];

mat_c = matmul342( mat_a, mat_b );
/* mat_c has the value:
   [170, 180, 
    426, 452, 
    682, 724
   ]
*/
</code></pre>

<p>So <code>matmul342</code> works fine. But does it bring any improvement over a standard matrix multiplication loop?</p>

<p><button id="tryit_speed_matmul342" onclick="tryit_speed_matmul342( this )">Measure the speed!</button> (Feel free to do it multiple times.)</p><pre id="tryit_speed_matmul342_output">(The speed measurement can last long in some browsers.)</pre>

<p>In Firefox&nbsp;21 on a linux Ubuntu 12.04, I obtained a slowdown about&nbsp;-33%, and in Chrome&nbsp;27 a speedup about&nbsp;+200%. There are more results <a href="#push-all">below</a>, with large speedups for Firefox as well.</p>


</div>










<h3 class="anchorable" id="dft">Discrete Fourier Transform (DFT) <a href="#dft" class="anchor">#</a></h3>


<p>We now implement a DFT using the
Cooley-Tukey algorithm for both
real &amp; complex inputs (option). The implementation <code>dft_ditfft2</code> shows that we can express recursive
mathematical expressions in a "natural" way, that is very close to the
original <a href='http://en.wikipedia.org/wiki/Cooley%E2%80%93Tukey_FFT_algorithm#Pseudocode'>pseudocode</a>.</p>

<pre class="prettyprint lang-js"><code>dftreal16flat = flatorize('arr', dft_exprgenF( 4, { real: true } ));

<script type="text/javascript">document.write(dft_exprgenF+'');</script>
</code></pre>

<p id="dft16-generate">Let us now test it on a "small" scale (16 point). First, let us generate the code:</p>

<p><button id="tryit_flatorize_dft16" onclick="tryit_flatorize_dft( this, 16 )">Try <code>flatorize</code>!</button>&nbsp;</p><p id="tryit_flatorize_dft16_output" class="generated-code-output"></p>

<p>So the code generation of a "flatorized" 16-point DFT takes very little time. This has to be done only one time.</p>

<p>Now that we have a "flatorized" implementation, let us check whether it runs faster than the original Cooley-Tukey:</p>

<p><button id="tryit_speed_dft16" onclick="tryit_speed_dft( this, 16 )">Measure the speed!</button> (Feel free to do it multiple times.)</p><pre id="tryit_speed_dft16_output">(The speed measurement can last long in some browsers.)</pre>

<p>On a linux Ubuntu 12.04, I obtained with Firefox&nbsp;21 a speedup of about&nbsp;+2000%, and with Chrome&nbsp;27 about&nbsp;+1250%.</p>

<h3 class="anchorable" id="push-dft1024">Pushing it: 1024-point Discrete Fourier Transform (DFT) <a href="#push-dft1024" class="anchor">#</a></h3>

<pre class="prettyprint lang-js"><code>dftreal1024flat = flatorize('arr', dft_exprgenF( 10, { real: true } ));</code></pre>

<p>Since the recursion depth \(log_2{1024}=10\) starts to be quite significant, one can wonder how long the call to `flatorize` itself will take.</p>
<p><button id="tryit_flatorize_dft1024" onclick="console.profile('xxxdft1024gen');tryit_flatorize_dft( this, 1024 );console.profileEnd('xxxdft1024gen');">Try <code>flatorize</code>!</button>&nbsp;(This one can last a few seconds.)</p><p id="tryit_flatorize_dft1024_output" class="generated-code-output"></p>

<p>Now, let us measure how fast the flatorized DFT1024 implementation runs, as compared
with the original Cooley-Tukey:</p>
<p><button id="tryit_speed_dft1024" onclick="tryit_speed_dft( this, 1024 )">Measure the speed!</button> (Feel free to do it multiple times.)</p><pre id="tryit_speed_dft1024_output">(The speed measurement can last long in some browsers.)</pre>

<p>In Chrome&nbsp;27 on a linux Ubuntu 12.04, I got a small speedup +50% by the first measurement, and afterwards a consistent speedup of about +150%. In Firefox&nbsp;21 I got a consistent speedup of about +350%.</p>

<h3 class="anchorable" id="push-all">Pushing it: all performance results <a href="#push-all" class="anchor">#</a></h3>

<p>Speedup brought by <code>flatorize</code>:</p>

<ul>
  <li>System: linux Ubuntu 12.04 on a Thinkpad T420s.</li>
  <li>(1st): first measurement.</li>
  <li>(2+): second measurement and following measurements.</li>
</ul>

<table id="all-perf">
  <thead>
    <tr><th class="table-left">Speedup on:</th><th><code><a href="#matmul">matmul342</a></code></th><th><code><a href="#dft">DFT16</a></code></th><th><code>DFT32</code></th><th><code>DFT64</code></th><th><code>DFT128</code></th><th><code>DFT256</code></th><th><code>DFT512</code></th><th><code><a href="#push-dft1024">DFT1024</a></code></th></tr>
  </thead>
  <tbody>

    <tr class="table-sep"><td class="table-left" colspan="9"><hr></td></tr>

    <!--tr id="all-perf-firefox19-first"><td class="table-left">Firefox&nbsp;19&nbsp;(1st)</td><td class="sad" id="all-perf-firefox19-first-matmul342">-28%</td><td class="happy" id="all-perf-firefox19-first-dft16">+1574%</td><td class="happy" id="all-perf-firefox19-first-dft32">+1822%</td><td class="happy" id="all-perf-firefox19-first-dft64">+1733%</td><td class="happy" id="all-perf-firefox19-first-dft128">+819%</td><td class="happy" id="all-perf-firefox19-first-dft256">+452%</td><td class="happy" id="all-perf-firefox19-first-dft512">+324%</td><td class="happy" id="all-perf-firefox19-first-dft1024">+291%</td></tr>

    <tr id="all-perf-firefox19-after"><td class="table-left">Firefox&nbsp;19&nbsp;(2+)</td><td class="sad" id="all-perf-firefox19-after-matmul342">-27%</td><td class="happy" id="all-perf-firefox19-after-dft16">+1546%</td><td class="happy" id="all-perf-firefox19-after-dft32">+1798%</td><td class="happy" id="all-perf-firefox19-after-dft64">+1858%</td><td class="happy" id="all-perf-firefox19-after-dft128">+842%</td><td class="happy" id="all-perf-firefox19-after-dft256">+470%</td><td class="happy" id="all-perf-firefox19-after-dft512">+334%</td><td class="happy" id="all-perf-firefox19-after-dft1024">+297%</td></tr-->

    <!-- <tr><td class="table-left">Firefox&nbsp;21&nbsp;(1st)</td><td class="sad" id="all-perf-firefox-21-run-1-matmul342">-33%</td><td class="happy" id="all-perf-firefox-21-run-1-dft16">+2094%</td><td class="happy" id="all-perf-firefox-21-run-1-dft32">+2451%</td><td class="happy" id="all-perf-firefox-21-run-1-dft64">+2383%</td><td class="happy" id="all-perf-firefox-21-run-1-dft128">+1562%</td><td class="happy" id="all-perf-firefox-21-run-1-dft256">+429%</td><td class="happy" id="all-perf-firefox-21-run-1-dft512">+354%</td><td class="happy" id="all-perf-firefox-21-run-1-dft1024">+329%</td></tr> -->

    <!-- <tr><td class="table-left">Firefox&nbsp;21&nbsp;(2nd)</td><td class="sad" id="all-perf-firefox-21-run-2-matmul342">-33%</td><td class="happy" id="all-perf-firefox-21-run-2-dft16">+1665%</td><td class="happy" id="all-perf-firefox-21-run-2-dft32">+2361%</td><td class="happy" id="all-perf-firefox-21-run-2-dft64">+2399%</td><td class="happy" id="all-perf-firefox-21-run-2-dft128">+1593%</td><td class="happy" id="all-perf-firefox-21-run-2-dft256">+811%</td><td class="happy" id="all-perf-firefox-21-run-2-dft512">+425%</td><td class="happy" id="all-perf-firefox-21-run-2-dft1024">+371%</td></tr> -->

    <!-- <tr><td class="table-left">Firefox&nbsp;21&nbsp;(3rd)</td><td class="sad" id="all-perf-firefox-21-run-3-matmul342">-33%</td><td class="happy" id="all-perf-firefox-21-run-3-dft16">+2425%</td><td class="happy" id="all-perf-firefox-21-run-3-dft32">+2434%</td><td class="happy" id="all-perf-firefox-21-run-3-dft64">+2350%</td><td class="happy" id="all-perf-firefox-21-run-3-dft128">+1572%</td><td class="happy" id="all-perf-firefox-21-run-3-dft256">+783%</td><td class="happy" id="all-perf-firefox-21-run-3-dft512">+416%</td><td class="happy" id="all-perf-firefox-21-run-3-dft1024">+363%</td></tr> -->

    <tr><td class="table-left">Firefox&nbsp;26&nbsp;(1st)</td><td class="happy" id="all-perf-yours-run-1-matmul342">+615%</td><td class="happy" id="all-perf-yours-run-1-dft16">+2532%</td><td class="happy" id="all-perf-yours-run-1-dft32">+1755%</td><td class="happy" id="all-perf-yours-run-1-dft64">+1011%</td><td class="happy" id="all-perf-yours-run-1-dft128">+638%</td><td class="happy" id="all-perf-yours-run-1-dft256">+602%</td><td class="happy" id="all-perf-yours-run-1-dft512">+597%</td><td class="happy" id="all-perf-yours-run-1-dft1024">+624%</td></tr>

    <tr><td class="table-left">Firefox&nbsp;26&nbsp;(2nd)</td><td class="happy" id="all-perf-yours-run-2-matmul342">+399%</td><td class="happy" id="all-perf-yours-run-2-dft16">+2067%</td><td class="happy" id="all-perf-yours-run-2-dft32">+1309%</td><td class="happy" id="all-perf-yours-run-2-dft64">+830%</td><td class="happy" id="all-perf-yours-run-2-dft128">+649%</td><td class="happy" id="all-perf-yours-run-2-dft256">+654%</td><td class="happy" id="all-perf-yours-run-2-dft512">+702%</td><td class="happy" id="all-perf-yours-run-2-dft1024">+301%</td></tr>

    <tr><td class="table-left">Firefox&nbsp;26&nbsp;(3rd)</td><td class="happy" id="all-perf-yours-run-3-matmul342">+434%</td><td class="happy" id="all-perf-yours-run-3-dft16">+1945%</td><td class="happy" id="all-perf-yours-run-3-dft32">+2076%</td><td class="happy" id="all-perf-yours-run-3-dft64">+936%</td><td class="happy" id="all-perf-yours-run-3-dft128">+713%</td><td class="happy" id="all-perf-yours-run-3-dft256">+743%</td><td class="happy" id="all-perf-yours-run-3-dft512">+685%</td><td class="happy" id="all-perf-yours-run-3-dft1024">+383%</td></tr>
    
    <tr class="table-sep"><td class="table-left" colspan="9"><hr></td></tr>

    <!-- <tr><td class="table-left">Chrome&nbsp;27&nbsp;(1st)</td><td class="happy" id="all-perf-chrome27-run-1-matmul342">+220%</td><td class="happy" id="all-perf-chrome27-run-1-dft16">+1063%</td><td class="happy" id="all-perf-chrome27-run-1-dft32">+1040%</td><td class="happy" id="all-perf-chrome27-run-1-dft64">+951%</td><td class="happy" id="all-perf-chrome27-run-1-dft128">+685%</td><td class="happy" id="all-perf-chrome27-run-1-dft256">+557%</td><td class="happy" id="all-perf-chrome27-run-1-dft512">+541%</td><td class="happy" id="all-perf-chrome27-run-1-dft1024">+472%</td></tr> -->
    
    <!-- <tr><td class="table-left">Chrome&nbsp;27&nbsp;(2)</td><td class="happy" id="all-perf-chrome27-run-2-matmul342">+216%</td><td class="happy" id="all-perf-chrome27-run-2-dft16">+981%</td><td class="happy" id="all-perf-chrome27-run-2-dft32">+1063%</td><td class="happy" id="all-perf-chrome27-run-2-dft64">+945%</td><td class="happy" id="all-perf-chrome27-run-2-dft128">+695%</td><td class="happy" id="all-perf-chrome27-run-2-dft256">+624%</td><td class="happy" id="all-perf-chrome27-run-2-dft512">+597%</td><td class="happy" id="all-perf-chrome27-run-2-dft1024">+572%</td></tr> -->
    
    <!-- <tr><td class="table-left">Chrome&nbsp;27&nbsp;(3)</td><td class="happy" id="all-perf-chrome27-run-3-matmul342">+221%</td><td class="happy" id="all-perf-chrome27-run-3-dft16">+1060%</td><td class="happy" id="all-perf-chrome27-run-3-dft32">+1063%</td><td class="happy" id="all-perf-chrome27-run-3-dft64">+924%</td><td class="happy" id="all-perf-chrome27-run-3-dft128">+683%</td><td class="happy" id="all-perf-chrome27-run-3-dft256">+614%</td><td class="happy" id="all-perf-chrome27-run-3-dft512">+610%</td><td class="happy" id="all-perf-chrome27-run-3-dft1024">+573%</td></tr> -->

    <tr><td class="table-left">Chrome&nbsp;32&nbsp;(1st)</td><td class="happy" id="all-perf-yours-run-1-matmul342">+87%</td><td class="happy" id="all-perf-yours-run-1-dft16">+1388%</td><td class="happy" id="all-perf-yours-run-1-dft32">+1072%</td><td class="happy" id="all-perf-yours-run-1-dft64">+1421%</td><td class="happy" id="all-perf-yours-run-1-dft128">+577%</td><td class="happy" id="all-perf-yours-run-1-dft256">+264%</td><td class="sad" id="all-perf-yours-run-1-dft512">-3%</td><td class="sad" id="all-perf-yours-run-1-dft1024">-67%</td></tr>

    <tr><td class="table-left">Chrome&nbsp;32&nbsp;(2nd)</td><td class="happy" id="all-perf-yours-run-2-matmul342">+102%</td><td class="happy" id="all-perf-yours-run-2-dft16">+1044%</td><td class="happy" id="all-perf-yours-run-2-dft32">+1284%</td><td class="happy" id="all-perf-yours-run-2-dft64">+1557%</td><td class="happy" id="all-perf-yours-run-2-dft128">+1409%</td><td class="happy" id="all-perf-yours-run-2-dft256">+1600%</td><td class="happy" id="all-perf-yours-run-2-dft512">+1440%</td><td class="happy" id="all-perf-yours-run-2-dft1024">+1462%</td></tr>

    <tr><td class="table-left">Chrome&nbsp;32&nbsp;(3rd)</td><td class="happy" id="all-perf-yours-run-4-matmul342">+98%</td><td class="happy" id="all-perf-yours-run-4-dft16">+1107%</td><td class="happy" id="all-perf-yours-run-4-dft32">+1141%</td><td class="happy" id="all-perf-yours-run-4-dft64">+1285%</td><td class="happy" id="all-perf-yours-run-4-dft128">+1428%</td><td class="happy" id="all-perf-yours-run-4-dft256">+1404%</td><td class="happy" id="all-perf-yours-run-4-dft512">+1515%</td><td class="happy" id="all-perf-yours-run-4-dft1024">+1580%</td></tr>

    <tr class="table-sep"><td class="table-left" colspan="9"><hr></td></tr>

    <!-- <tr id="all-perf-v8_3_19_10_first"><td class="table-left">V8&nbsp;3.19.10&nbsp;(1st)</td><td class="happy" id="all-perf-v8_3_19_10_first-matmul342">+72%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft16">+1618%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft32">+1783%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft64">+858%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft128">+396%</td><td class="sad" id="all-perf-v8_3_19_10_first-dft256">+95</td><td class="sad" id="all-perf-v8_3_19_10_first-dft512">-48%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft1024">-87%</td></tr> -->

    <!-- <tr id="all-perf-v8_3_19_10-after"><td class="table-left">V8&nbsp;3.19.10&nbsp;(2nd)</td><td class="happy" id="all-perf-v8_3_19_10-after-matmul342">+83%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft16">+1781%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft32">+2639%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft64">+1544%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft128">+1146%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft256">+1373%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft512">+1238%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft1024">+1221%</td></tr> -->

    <!-- <tr id="all-perf-v8_3_19_10-after"><td class="table-left">V8&nbsp;3.19.10&nbsp;(3rd)</td><td class="happy" id="all-perf-v8_3_19_10-after-matmul342">+79%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft16">+1790%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft32">+2639%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft64">+1547%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft128">+1389%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft256">+1373%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft512">+1233%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft1024">+1187%</td></tr> -->


    <tr id="all-perf-v8_3_19_10_first"><td class="table-left">V8&nbsp;3.19.10&nbsp;(1st)</td><td class="happy" id="all-perf-v8_3_19_10_first-matmul342">+74%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft16">+1548%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft32">+1987%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft64">+1271%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft128">+548%</td><td class="happy" id="all-perf-v8_3_19_10_first-dft256">+194%</td><td class="sad" id="all-perf-v8_3_19_10_first-dft512">-12%</td><td class="sad" id="all-perf-v8_3_19_10_first-dft1024">-77%</td></tr>

    <tr id="all-perf-v8_3_19_10-after"><td class="table-left">V8&nbsp;3.19.10&nbsp;(2nd)</td><td class="happy" id="all-perf-v8_3_19_10-after-matmul342">+80%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft16">+1735%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft32">+2618%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft64">+2233%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft128">+1695%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft256">+1785%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft512">+1548%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft1024">+1587%</td></tr>

    <tr id="all-perf-v8_3_19_10-after"><td class="table-left">V8&nbsp;3.19.10&nbsp;(3rd)</td><td class="happy" id="all-perf-v8_3_19_10-after-matmul342">+79%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft16">+1643%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft32">+2461%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft64">+2233%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft128">+1695%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft256">+1793%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft512">+1546%</td><td class="happy" id="all-perf-v8_3_19_10-after-dft1024">+1590%</td></tr>

    <tr class="table-sep"><td class="table-left" colspan="9"><hr></td></tr>

    <tr id="all-perf-yours-choice">
      <td></td>
      <td><input type="checkbox" id="tryit_cb_matmul342" checked="checked"></td>
      <td><input type="checkbox" id="tryit_cb_dft16" checked="checked"></td>
      <td><input type="checkbox" id="tryit_cb_dft32" checked="checked"></td>
      <td><input type="checkbox" id="tryit_cb_dft64" checked="checked"></td>
      <td><input type="checkbox" id="tryit_cb_dft128" checked="checked"></td>
      <td><input type="checkbox" id="tryit_cb_dft256" checked="checked"></td>
      <td><input type="checkbox" id="tryit_cb_dft512" checked="checked"></td>
      <td><input type="checkbox" id="tryit_cb_dft1024" checked="checked"></td>
    </tr>
    
    <tr id="all-perf-yours"><td class="table-left"><button id="tryit_all" onclick="tryit_all( this, { except : { matmul342 : !document.getElementById('tryit_cb_matmul342').checked, dft16 : !document.getElementById('tryit_cb_dft16').checked, dft32 : !document.getElementById('tryit_cb_dft32').checked, dft64 : !document.getElementById('tryit_cb_dft64').checked, dft128 : !document.getElementById('tryit_cb_dft128').checked, dft256 : !document.getElementById('tryit_cb_dft256').checked, dft512 : !document.getElementById('tryit_cb_dft512').checked, dft1024 : !document.getElementById('tryit_cb_dft1024').checked } } )">Run now!</button><td id="all-perf-yours-matmul342"></td><td id="all-perf-yours-dft16"></td><td id="all-perf-yours-dft32"></td><td id="all-perf-yours-dft64"></td><td id="all-perf-yours-dft128"></td><td id="all-perf-yours-dft256"></td><td id="all-perf-yours-dft512"></td><td id="all-perf-yours-dft1024"></td></tr>
    
  </tbody>
</table>

<p>(Feel free to do it multiple times.)</p>

<h4 class="anchorable" id="push-all-speedup">Result analysis: speedup <a href="#push-all-speedup" class="anchor">#</a></h4>

<p>Firefox&nbsp;26 shows excellent speedups everywhere.</p>

<p>Chrome&nbsp;32 and V8&nbsp;3.19.10 mostly show excellent speedups, especially after the first pass, which likely triggers code optimization.</p>

<h4 class="anchorable" id="push-all-memory">Result analysis: memory <a href="#push-all-memory" class="anchor">#</a></h4>

<p>In all environments the memory consumption remains very stable.</p>


<h3 class="anchorable" id="conclusion">Conclusion <a href="#conclusion" class="anchor">#</a></h3>

<p>The huge performance improvements validate the interest of <code>flatorize</code>.
Further speedups could involve <a href="http://asmjs.org"><code>asm.js</code></a><span class="screen-hidden">&nbsp;[2]</span>, <a href="http://www.khronos.org/webcl/">WebCL</a>, <a href="http://code.google.com/p/nativeclient/">NaCl</a> or <a href="http://www.chromium.org/nativeclient/pnacl/building-and-testing-portable-native-client">PNaCl</a>.
</p>

<hr class="section-hr">

<h3 class="anchorable" id="ack">Acknowledgments <a href="#ack" class="anchor">#</a></h3>

<p>Big thanks to the V8 developers, who solved issue&nbsp;<a href="http://code.google.com/p/v8/issues/detail?id=2612">#2612</a> in record time (concerning Chrome 24 and V8 3.17).</p>

<hr class="section-hr">

<h3 class="anchorable" id="disclaimer">Disclaimer <a href="#disclaimer" class="anchor">#</a></h3>

<p>By no means did I intend <code>flatorize</code> to compete with highly specialized and/or native implementations <em>of a particular task</em> (e.g. <a href="http://fftw.org">FFTW</a> to implement DFT).</p>
<p>Rather, this simple, task-agnostic approach &ndash;&nbsp;factorizing and flattening&nbsp;&ndash; can give <em>huge enough</em> performance gains in many cases, which spares us the development and maintainance costs of  "going native".</p>

<hr class="section-hr">

<h3 class="anchorable" id="details">Miscellaneous details <a href="#details" class="anchor">#</a></h3>


<p>Above in the article, the three main functions were described: <code>flatorize</code>, <code>flatorize.expr</code> and <code>flatorize.part</code>. In addition:</p>
<ol>
  <li>The method <code>getDirect</code> and the convenience function <code>flatorize.now</code> give you direct access to the flatorized implementation, which you can use for computations (even better performance). <code>flatorize.now</code> makes sense when you know that you will never use the flatorized function to build further expressions, e.g. in specific cases of a parameterizable implementation (<code>matmul342</code>); else use <code>getDirect</code>.</li>
  <li>Within a function that builds an expression, a call to the method <code>evalnow</code> delivers a value (instead of an expression). See <a href="#dft">above</a> the call <code>cpol.evalnow</code> within <code>dft_exprgenF</code>.</li>
</ol>
<p>For more details about these two points, and examples, you can have a look at the sources on <a href="https://github.com/glathoud/flatorize">github</a> or here (files <a href="flatorize.js">flatorize.js</a> and <a href="examples.js">examples.js</a>).</p>

<p>.</p>

<p>V8: Several <code>.sh</code> files are provided to run the tests on
V8,
including <a href="d8_tryit_speed_all.sh">d8_tryit_speed_all.sh</a>
and <a href="d8_tryit_speed_dft1024.sh">d8_tryit_speed_dft1024.sh</a>;
the rest on <a href="https://github.com/glathoud/flatorize">github</a>.</p>

<p>.</p>

<p>Flatorizing DFT1024 in a tractable time &ndash; order of magnitude: 1 second &ndash; actually required a bit of work, which you can look at in the directory "<a href="OLD">OLD</a>" (<code>cplx_v*.js</code> files). The method is not specific to DFT, but rather very generic. The resulting, cleaned-up implementation: <a href="flatorize.js">flatorize.js</a>
</p>

<hr class="section-hr">

<h3 class="anchorable" id="license">License <a href="#license" class="anchor">#</a></h3>

<object width="100%" height="350px" type="text/plain" data="LICENSE.TXT"></object>



<script type="text/javascript" src="prettify/prettify.js"></script>
<script type="text/javascript">setTimeout( prettyPrint );</script>
<script type="text/javascript">
[ 
    'tryit_speed_matmul342', 'tryit_speed_matmulrows_zip', 'tryit_flatorize_dft16', 'tryit_speed_dft16', 'tryit_flatorize_dft1024', 'tryit_speed_dft1024', 'tryit_all'
].forEach(
    function (id) { document.getElementById(id).removeAttribute('disabled'); }
);
window.ontouchstart = function () { Array.prototype.forEach.call( document.getElementsByClassName( "anchor" ), function (node) { node.className = node.className.replace( /\banchor\b/g, '' ); } ); };
</script>
<script type="text/javascript" src="../MathJax/MathJax.js?config=default"></script>
<script type="text/javascript">
if (!/\d+\.\d+\.\d+\.\d+|localhost/.test( location.hostname ))
{
var _gaq = _gaq || [];  _gaq.push(['_setAccount', 'UA-5516483-1']);  _gaq.push(['_trackPageview']);  (function() {    var ga = document.createElement('script');    ga.src = ('https:' == document.location.protocol ? 'https://ssl' :         'http://www') + '.google-analytics.com/ga.js';    ga.setAttribute('async', 'true');    document.documentElement.firstChild.appendChild(ga);  })();
}
</script>

</body>
</html>
