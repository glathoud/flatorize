<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8" /> 
<title>Flatorize: Generate fast asm.js code</title>
<link rel="stylesheet" type="text/css" href="prettify/prettify.css">
<link rel="stylesheet" type="text/css" href="flatorize.css">
<script type="text/javascript" src="log.js"></script>
<script type="text/javascript" src="flatorize.js"></script>
<script type="text/javascript" src="examples.js"></script>
<script type="text/javascript">generate_small_functions();</script>

<script type="text/javascript" src="flatorize_asmjs.js"></script>
<script type="text/javascript" src="modifsplitradix.js"></script> <!-- xxx check whether really needed -->

<script type="text/javascript" src="expl/matmulrows_zip_flatorize.js"></script>
<script type="text/javascript" src="expl/dftreal16_flatorize.js"></script>

<script type="text/javascript" src="asmjs_complex_numbers_check.js"></script>
<script type="text/javascript" src="asmjs_matmulrows_zip_342_check.js"></script>
<script type="text/javascript" src="asmjs_dftreal16flat_check.js"></script>

</head>
<body>

<a href="https://github.com/glathoud/flatorize" class="print-hidden">
  <img style="position: fixed; top: 0; right: 0; border: 0; margin: 0; padding: 0;"
       src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
       alt="Fork me on GitHub">
</a>

<p><a href="index.html">Back to the main article</a></p>

<h2><code>flatorize_asmjs</code>: Generate fast <code>asm.js</code> code</h2>

<p style="text-align:right">by <a href="http://glat.info">Guillaume Lathoud</a><span class="print">&nbsp;[1]</span>, September 2014</p>

<div class="fixed-br print-hidden"><a href="#top">Back to the top</a></div>


<p>This page presents a plugin method <code>flatorize.getAsmjs()</code> (GitHub <a href="https://github.com/glathoud/flatorize/blob/master/flatorize_asmjs.js">source</a>) that goes on top of <code>flatorize</code> (see the <a href="index.html">main article</a>, GitHub <a href="https://github.com/glathoud/flatorize/blob/master/flatorize.js">source</a>).</p>

<p>Several examples describe how to use <code>flatorize.getAsmjs()</code> to generate <code>asm.js</code> implementations that run very fast in at least Firefox and Chrome. </p>

<p>Each input or output can be a number or an array of numbers. All arrays are grouped into a single one (inputs and/or output), so they must have the same type: <code>double</code>, <code>float</code> or <code>int</code> in <code>flatorize</code> notation, i.e. respectively <code>Float64Array</code>, <code>Float32Array</code> or <code>Int32Array</code> in JavaScript notation.</p>


<h3 class="anchorable" id="contents">Contents <a href="#contents" class="anchor">#</a></h3>

<ul class="contents-ul"></ul>







<h3 class="anchorable" id="f2">Complex numbers (HOWTO example)<a href="#f2" class="anchor">#</a></h3>

<p>Expression definition  (details in the <a href="index.html#example">main article</a>):</p>
<pre class="prettyprint lang-js"><code>// f:
<script type="text/javascript">document.write(f2.exprgen+"");</script></code></pre>

<p>A call to <code>flatorize()</code>:</p>
<pre class="prettyprint lang-js"><code>// note the type declarations, ignored by JavaScript but used later for asm.js
f2 = flatorize('a:[2 float],b:[2 float],c:[2 float]->d:[2 float]',f);
</code></pre>

<p>...generates flatorized JavaScript code:</p>
<pre class="prettyprint lang-js"><code>// f2.getDirect():
<script type="text/javascript">document.write(f2.getDirect()+"");</script></code></pre>

<p>Then, a call to <code>flatorize.getAsmjs()</code>:</p>
<script type="text/javascript" id="script-gen-f2_asmjs">var f2_asmjsGen = flatorize.getAsmjsGen( { switcher: f2, name: "f2" } );</script>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(document.getElementById("script-gen-f2_asmjs").textContent);</script></code></pre>

<p>...returns an <code>asm.js</code> generator:</p>

<pre class="prettyprint lang-js"><code>// f2_asmjsGen:
<script type="text/javascript">document.write(f2_asmjsGen+'')</script>
</code></pre>


<p>The generator can be used as follows to compile and use the <code>asm.js</code> code:</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(asmjs_complex_numbers_check);</script></code></pre>
<script type="text/javascript">asmjs_complex_numbers_check();</script>
<p class="small">(This check, as a few others below, ran as you loaded the page.)</p>




















<h3 class="anchorable" id="matmulrows">2-dimensional array example: matrix multiplication<a href="#matmulrows" class="anchor">#</a></h3>

<script type="text/javascript">expl_matmulrows_zip_flatorize();</script>

<p>A call to <code>flatorize()</code> (details in the <a href="index.html#zipflat">main article</a>):</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(/^\s*var\s+matmulrows_zip_342\s+=\s+flatorize\([\s\S]*?^\s*?\);\s*?$/m.exec(expl_matmulrows_zip_flatorize+'')[0].replace(/^\s\s\s\s\s/gm,''))</script>
</code></pre>

<p>...generates flatorized JavaScript code:</p>
<pre class="prettyprint lang-js"><code>// matmulrows_zip_342.getDirect():
<script type="text/javascript">var matmulrows_zip_342 = expl_matmulrows_zip_flatorize.matmulrows_zip_342;
document.write(matmulrows_zip_342.getDirect()+"");</script></code></pre>

<p>Then, a call to <code>flatorize.getAsmjs()</code>:</p>
<script type="text/javascript" id="script-gen-matmulrows_zip_342_asmjs">var matmulrows_zip_342_asmjsGen = flatorize.getAsmjsGen( 
  { switcher: matmulrows_zip_342, name: "matmulrows_zip_342" } 
);</script>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(document.getElementById("script-gen-matmulrows_zip_342_asmjs").textContent);</script></code></pre>

<p>...returns an <code>asm.js</code> generator:</p>

<pre class="prettyprint lang-js"><code>// matmulrows_zip_342_asmjsGen:
<script type="text/javascript">document.write(matmulrows_zip_342_asmjsGen+'')</script>
</code></pre>


<p>The generator can be used as follows to compile and use the <code>asm.js</code> code:</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(asmjs_matmulrows_zip_342_check);</script></code></pre>
<script type="text/javascript">asmjs_matmulrows_zip_342_check();</script>















<h3 class="anchorable" id="dftreal16">Discrete Fourier Transform: DFT16 (real signals)<a href="#dftreal16" class="anchor">#</a></h3>

<script type="text/javascript">expl_dftreal16_flatorize();</script>

<p>A call to <code>flatorize()</code> (details in the <a href="index.html#dft">main article</a>):</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(/var\s+power\b[^;]*?;/m.exec(expl_dftreal16_flatorize+'')[0].replace(/^\s\s\s\s\s/gm,''))</script>
</code></pre>

<p>...generates flatorized JavaScript code:</p>
<pre class="prettyprint lang-js"><code>// dftreal16flat.getDirect():
<script type="text/javascript">var dftreal16flat = expl_dftreal16_flatorize.dftreal16flat;
document.write(dftreal16flat.getDirect()+"");</script></code></pre>

<p>Then, a call to <code>flatorize.getAsmjs()</code>:</p>
<script type="text/javascript" id="script-gen-dftreal16flat_asmjs">var dftreal16flat_asmjsGen = flatorize.getAsmjsGen( 
  { switcher: dftreal16flat, name: "dftreal16flat" } 
);</script>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(document.getElementById("script-gen-dftreal16flat_asmjs").textContent);</script></code></pre>

<p>...returns an <code>asm.js</code> generator:</p>

<pre class="prettyprint lang-js"><code>// dftreal16flat_asmjsGen:
<script type="text/javascript">document.write(dftreal16flat_asmjsGen+'')</script>
</code></pre>


<p>The generator can be used as follows to compile and use the <code>asm.js</code> code:</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(asmjs_dftreal16flat_check);</script></code></pre>
<script type="text/javascript">asmjs_dftreal16flat_check()</script>





















<h3 class="anchorable" id="test-summary">Test summary<a href="#test-summary" class="anchor">#</a></h3>

<p><span id="global-result"></span>.</p>

<p>Detail:</p>
<ul>
<script type="text/javascript">
var passed;
var all_passed;
(function ()
{
    var empty = {};
    all_passed = passed  &&  Object.keys( passed ).map( function (k) { 
        if (k in empty)
            return true;
  
        var pk = passed[ k ];
        document.write( '\x3Cli\x3E' + k + ' \x3Cspan class="' + (pk  ?  'happy'  :  'sad') + '"\x3E' + (pk  ?  'passed'  :  'failed')+ '.\x3C/span\x3E' +  '\x3C/li\x3E' );
    
        return pk;
    }).every( function (x) { return x; }); 
    
    document.getElementById('global-result').innerHTML = all_passed  ?  'ALL TESTS \x3Cspan class="happy"\x3Epassed\x3C/span\x3E'  :  'Some test(s) \x3Cspan class="sad"\x3EFAILED\x3C/span\x3E';
})();
</script>
</ul>
</p>










<h3 class="anchorable" id="performance">Performance (under construction)<a href="#performance" class="anchor">#</a></h3>


<script type="text/javascript">
function xxxperf()
{
var input = new Array(16).join(',').split(',').map( Math.random )
, N = 1e6
;

var flatimpl = dftreal16flat.getDirect();
console.time('flatorized')
for (var i = N; i--;)
    var output = flatimpl( input );
console.timeEnd('flatorized')

   // --- Inputs and output
    var dftreal16flat_buffer = new ArrayBuffer( 
        dftreal16flat_asmjsGen.buffer_bytes 
    );

    // --- Compile the asm.js code
    var dftreal16flat_asmjsO = dftreal16flat_asmjsGen( 
        window, {}, dftreal16flat_buffer 
    );

    // --- Example of use

    var      n2i = dftreal16flat_asmjsGen.array_name2info
    , TypedArray = dftreal16flat_asmjsGen.TypedArray
    
    // Input views

    , arr  = new TypedArray( 
        dftreal16flat_buffer, n2i.arr.begin_bytes, n2i.arr.n 
    )
    
    // Output view                                  

    , freq = new TypedArray( 
        dftreal16flat_buffer, n2i.freq.begin_bytes, n2i.freq.n 
    )
    ;

    // Write input values
arr.set( input );

console.time('flatorized+asm.js');
for (var i = N; i--;)
   dftreal16flat_asmjsO.dftreal16flat();
console.timeEnd('flatorized+asm.js');

}
</script>


<pre>
Firefox on DFT REAL 16:

flatorized: 647.95ms
flatorized+asm.js deactivated (no "use asm"): 130.51ms (fine)
flatorized+asm.js: 364.52ms (fine but lesser than without use asm - probably classical issue when test code NOT in asm.js)

.

Chrome on DFT REAL 16:

flatorized: 556.000ms
flatorized+asm.js deactivated (no "use asm"): 52.000ms (wow?)
flatorized+asm.js: 53.000ms (wow!)

</pre>

<p>xxx need to expand the tests, and write up this part</p>

<p>Not surprising, and not directly comparable, because output array creation vs. in-place, but still...</p>


<h4>wrapped with array/read-write for direct comparison</h4>

<script type="text/javascript">
function xxxperfwrapped()
{
var input = new Array(16).join(',').split(',').map( Math.random )
, N = 1e6
;

var flatimpl = dftreal16flat.getDirect();
console.time('flatorized')
for (var i = N; i--;)
    var output = flatimpl( input );
console.timeEnd('flatorized')

   // --- Inputs and output
    var dftreal16flat_buffer = new ArrayBuffer( 
        dftreal16flat_asmjsGen.buffer_bytes 
    );

    // --- Compile the asm.js code
    var dftreal16flat_asmjsO = dftreal16flat_asmjsGen( 
        window, {}, dftreal16flat_buffer 
    );

    // --- Example of use

    var      n2i = dftreal16flat_asmjsGen.array_name2info
    , TypedArray = dftreal16flat_asmjsGen.TypedArray
    
    // Input views

    , arr  = new TypedArray( 
        dftreal16flat_buffer, n2i.arr.begin_bytes, n2i.arr.n 
    )
    
    // Output view                                  

    , freq = new TypedArray( 
        dftreal16flat_buffer, n2i.freq.begin_bytes, n2i.freq.n 
    )
    ;

    // Write input values
console.time('flatorized+asm.js');
for (var i = N; i--;)
{
   arr.set( input );  // write
   dftreal16flat_asmjsO.dftreal16flat();
var output_freq = [].slice.call( output );  // read
}
console.timeEnd('flatorized+asm.js');

}
</script>

<pre>
Firefox

flatorized: 671.75ms
flatorized+asm.js wrapped: 920.15ms  (worse)
-> read/write cost about 920-360=560ms

.

Chrome

flatorized: 525.000ms 
flatorized+asm.js wrapped: 397.000ms    (still better!)
-> read/write cost about 400-50=350ms
</pre>








<script type="text/javascript" src="contents_ul.js"></script>

<script type="text/javascript" src="prettify/prettify.js"></script>
<script type="text/javascript">setTimeout( prettyPrint );</script>
<script type="text/javascript">
[].forEach.call( document.getElementsByTagName( 'button' ), function (btn_node) { btn_node.removeAttribute( 'disabled' ); } );
window.ontouchstart = function () { Array.prototype.forEach.call( document.getElementsByClassName( "anchor" ), function (node) { node.className = node.className.replace( /\banchor\b/g, '' ); } ); };
</script>
<script type="text/javascript" src="../MathJax/MathJax.js?config=default"></script>
<script type="text/javascript">
if (!/\d+\.\d+\.\d+\.\d+|localhost/.test( location.hostname ))
{
setTimeout( function () {
var _gaq = _gaq || [];  _gaq.push(['_setAccount', 'UA-5516483-1']);  _gaq.push(['_trackPageview']);  (function() {    var ga = document.createElement('script');    ga.src = ('https:' == document.location.protocol ? 'https://ssl' :         'http://www') + '.google-analytics.com/ga.js';    ga.setAttribute('async', 'true');    document.documentElement.firstChild.appendChild(ga);  })();
}, 0 );
}
</script>

</body>
</html>
