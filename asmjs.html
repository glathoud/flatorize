<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8" /> 
<title>Flatorize: Generate fast asm.js/TypedArray code</title>
<link rel="stylesheet" type="text/css" href="prettify/prettify.css">
<link rel="stylesheet" type="text/css" href="flatorize.css">
<script type="text/javascript" src="log.js"></script>
<script type="text/javascript" src="flatorize.js"></script>
<script type="text/javascript" src="examples.js"></script>
<script type="text/javascript">generate_small_functions();</script>

<script type="text/javascript" src="flatorize_asmjs.js"></script>
<script type="text/javascript" src="modifsplitradix.js"></script> <!-- xxx check whether really needed -->

<script type="text/javascript" src="expl.js"></script>

<script type="text/javascript" src="expl/matmulrows_zip_flatorize.js"></script>
<script type="text/javascript" src="expl/dftreal_flatorize.js"></script>

<script type="text/javascript" src="expl/asmjs_complex_numbers_check.js"></script>
<script type="text/javascript" src="expl/asmjs_matmulrows_zip_342_check.js"></script>
<script type="text/javascript" src="expl/asmjs_dftrealflat_check.js"></script>

<script type="text/javascript" src="expl/flatasmjs_scalar_from_scalar.js"></script>
<script type="text/javascript" src="expl/flatasmjs_scalar_from_array.js"></script>
<script type="text/javascript" src="expl/flatasmjs_scalar_from_matrix.js"></script>
<script type="text/javascript" src="expl/flatasmjs_scalar_from_ndim.js"></script>

<script type="text/javascript" src="expl/flatasmjs_array_from_scalar.js"></script>
<script type="text/javascript" src="expl/flatasmjs_array_from_array.js"></script>
<script type="text/javascript" src="expl/flatasmjs_array_from_matrix.js"></script>

<script type="text/javascript" src="expl/flatasmjs_matrix_from_scalar.js"></script>
<script type="text/javascript" src="expl/flatasmjs_matrix_from_array.js"></script>
<script type="text/javascript" src="expl/flatasmjs_matrix_from_matrix.js"></script>

</head>
<body>

<a href="https://github.com/glathoud/flatorize" class="print-hidden">
  <img style="position: fixed; top: 0; right: 0; border: 0; margin: 0; padding: 0;"
       src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
       alt="Fork me on GitHub">
</a>

<p><a href="index.html">Back to the main article</a></p>

<h2>Generate fast <code>asm.js</code>/<code>TypedArray</code> code</h2>

<p style="text-align:right">by <a href="http://glat.info">Guillaume Lathoud</a><span class="print">&nbsp;[1]</span>, September 2014</p>

<div class="fixed-br print-hidden"><a href="#top">Back to the top</a></div>


<p>This page presents a plugin method <code>flatorize.getAsmjs()</code> (GitHub <a href="https://github.com/glathoud/flatorize/blob/master/flatorize_asmjs.js">source</a>) that goes on top of <code>flatorize</code> (see the <a href="index.html">main article</a>, GitHub <a href="https://github.com/glathoud/flatorize/blob/master/flatorize.js">source</a>).</p>

<p>Examples describe how to use <code>flatorize.getAsmjs()</code> to generate <code>asm.js/TypedArray</code> code that runs <strong>very fast in at least Firefox &amp; Chrome</strong>. </p>

<p>Each input or output can be a number or an array of numbers. All arrays are grouped into a single one (inputs and/or output), so they must have the same type: <code>double</code>, <code>float</code> or <code>int</code> in <code>flatorize</code> notation, i.e. respectively <code>Float64Array</code>, <code>Float32Array</code> or <code>Int32Array</code> in JavaScript notation.</p>


<h3 class="anchorable" id="contents">Contents <a href="#contents" class="anchor">#</a></h3>

<ul class="contents-ul"></ul>

<p class="print-hidden"><span class="global-result"></span>.</p>





<h3 class="anchorable" id="f2">Complex numbers (HOWTO example)<a href="#f2" class="anchor">#</a></h3>

<p>Expression definition  (details in the <a href="index.html#example">main article</a>):</p>
<pre class="prettyprint lang-js"><code>// f:
<script type="text/javascript">document.write(f2.exprgen+"");</script></code></pre>

<p>A call to <code>flatorize()</code>:</p>
<pre class="prettyprint lang-js"><code>// note the type declarations, ignored by JavaScript but used later for asm.js
f2 = flatorize('a:[2 float],b:[2 float],c:[2 float]->d:[2 float]',f);
</code></pre>

<p>...generates flatorized JavaScript code:</p>
<pre class="prettyprint lang-js"><code>// f2.getDirect():
<script type="text/javascript">document.write(f2.getDirect()+"");</script></code></pre>

<p>Then, a call to <code>flatorize.getAsmjs()</code>:</p>
<script type="text/javascript" id="script-gen-f2_asmjs">var f2_asmjsGen = flatorize.getAsmjsGen( { switcher: f2, name: "f2" } );</script>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(document.getElementById("script-gen-f2_asmjs").textContent);</script></code></pre>

<p>...returns an <code>asm.js</code> generator:</p>

<pre class="prettyprint lang-js"><code>// f2_asmjsGen:
<script type="text/javascript">document.write(f2_asmjsGen+'')</script>
</code></pre>


<p>The generator can be used as follows to compile and use the <code>asm.js</code> code:</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(asmjs_complex_numbers_check);</script></code></pre>
<script type="text/javascript">asmjs_complex_numbers_check();</script>
<p class="small">(This check, as a few others below, ran as you loaded the page.)</p>




















<h3 class="anchorable" id="matmulrows">2-dimensional array example: matrix multiplication<a href="#matmulrows" class="anchor">#</a></h3>

<script type="text/javascript">expl_matmulrows_zip_flatorize();</script>

<p>A call to <code>flatorize()</code> (details in the <a href="index.html#zipflat">main article</a>):</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(/^\s*var\s+matmulrows_zip_342\s+=\s+flatorize\([\s\S]*?^\s*?\);\s*?$/m.exec(expl_matmulrows_zip_flatorize+'')[0].replace(/^\s\s\s\s\s/gm,''))</script>
</code></pre>

<p>...generates flatorized JavaScript code:</p>
<pre class="prettyprint lang-js"><code>// matmulrows_zip_342.getDirect():
<script type="text/javascript">var matmulrows_zip_342 = expl_matmulrows_zip_flatorize.matmulrows_zip_342;
document.write(matmulrows_zip_342.getDirect()+"");</script></code></pre>

<p>Then, a call to <code>flatorize.getAsmjs()</code>:</p>
<script type="text/javascript" id="script-gen-matmulrows_zip_342_asmjs">var matmulrows_zip_342_asmjsGen = flatorize.getAsmjsGen( 
  { switcher: matmulrows_zip_342, name: "matmulrows_zip_342" } 
);</script>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(document.getElementById("script-gen-matmulrows_zip_342_asmjs").textContent);</script></code></pre>

<p>...returns an <code>asm.js</code> generator:</p>

<pre class="prettyprint lang-js"><code>// matmulrows_zip_342_asmjsGen:
<script type="text/javascript">document.write(matmulrows_zip_342_asmjsGen+'')</script>
</code></pre>


<p>The generator can be used as follows to compile and use the <code>asm.js</code> code:</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(asmjs_matmulrows_zip_342_check);</script></code></pre>
<script type="text/javascript">asmjs_matmulrows_zip_342_check();</script>















<h3 class="anchorable" id="dftreal16">Discrete Fourier Transform: DFT16 (real signals)<a href="#dftreal16" class="anchor">#</a></h3>

<script type="text/javascript">expl_dftreal_flatorize( 16 );</script>

<p>A call to <code>flatorize()</code> (details in the <a href="index.html#dft">main article</a>):</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(/(var\s+power\b[\s\S]*?)(^\s*\/\/ Does this work)/m.exec(expl_dftreal_flatorize+'')[1].replace(/^\s\s\s\s\s/gm,''))</script></code></pre>

<p>...generates flatorized JavaScript code:</p>
<pre class="prettyprint lang-js"><code>// dftreal16flat.getDirect():
<script type="text/javascript">var dftreal16flat = expl_dftreal_flatorize.dftreal16flat;
document.write(dftreal16flat.getDirect()+"");</script></code></pre>

<p>Then, a call to <code>flatorize.getAsmjs()</code>:</p>
<script type="text/javascript" id="script-gen-dftreal16flat_asmjs">var dftreal16flat_asmjsGen = flatorize.getAsmjsGen( 
  { switcher: dftreal16flat, name: "dftreal16flat" } 
);</script>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(document.getElementById("script-gen-dftreal16flat_asmjs").textContent);</script></code></pre>

<p>...returns an <code>asm.js</code> generator:</p>

<pre class="prettyprint lang-js"><code>// dftreal16flat_asmjsGen:
<script type="text/javascript">document.write(dftreal16flat_asmjsGen+'')</script>
</code></pre>


<p>The generator can be used as follows to compile and use the <code>asm.js</code> code:</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript" id="asmjs_dftrealflat_check_script">asmjs_dftrealflat_check( 16 );</script><script type="text/javascript">document.write(document.getElementById("asmjs_dftrealflat_check_script").textContent)</script>

<script type="text/javascript">document.write(asmjs_dftrealflat_check);</script></code></pre>

























<h3 class="anchorable" id="dftreal1024">Discrete Fourier Transform: DFT1024 (real signals)<a href="#dftreal1024" class="anchor">#</a></h3>

<p>A call to <code>flatorize()</code> (details in the <a href="index.html#dft">main article</a>):</p>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(/(var\s+power\b[\s\S]*?)(^\s*\/\/ Does this work)/m.exec(expl_dftreal_flatorize+'')[1].replace(/^\s\s\s\s\s/gm,''))</script></code></pre>


<p>...generates flatorized JavaScript code:</p><!-- This takes a while so we do NOT do it on page load, only on user demand later on -->
<p><button disabled="disabled" onclick="genflatcode_dftreal1024flat()" id="genflatcode_dftreal1024flat_btn">Do it!</button> <small>(<span id="genflatcode_dftreal1024flat_duration">Might last a few seconds.</span>)</small></p>
<pre class="pre-scroll prettyprint"><code id="genflatcode_dftreal1024flat_output"></code></pre>
<script type="text/javascript">
var dftreal1024flat;
function genflatcode_dftreal1024flat()
{
    if (genflatcode_dftreal1024flat.called)
        return;
    genflatcode_dftreal1024flat.called = true;
    
    var button = document.getElementById( "genflatcode_dftreal1024flat_btn" );
    button.setAttribute( "disabled", "disabled" );
  

    var t_begin = Date.now();

    expl_dftreal_flatorize( 1024 );    

    var t_end = Date.now();


    dftreal1024flat = expl_dftreal_flatorize.dftreal1024flat;

    write_duration( t_end - t_begin, "genflatcode_dftreal1024flat_duration" );
    
    var outnode = document.getElementById( 'genflatcode_dftreal1024flat_output' );
    outnode.textContent = "// dftreal1024flat.getDirect():\n\n"+dftreal1024flat.getDirect();
}

function write_duration( duration_ms, idstring_or_node )
{
    var node = "string" === typeof idstring_or_node  ?  document.getElementById( idstring_or_node )  :  idstring_or_node;
    node.innerHTML = "Lasted " + ((duration_ms / 1000).toFixed(1)) + " seconds.";
}

</script>


<p>Then, a call to <code>flatorize.getAsmjs()</code>:</p>
<pre class="prettyprint lang-js"><code id="genflatcode_asmjs_dftreal1024flat_code">var dftreal1024flat_asmjsGen = flatorize.getAsmjsGen( 
  { switcher: dftreal1024flat, name: "dftreal1024flat" } 
);</code></pre>


<p>...returns an <code>asm.js</code> generator:</p><!-- This takes a while so we do NOT do it on page load, only on user demand later on -->
<p><button disabled="disabled" onclick="genflatcode_asmjs_dftreal1024flat()" id="genflatcode_asmjs_dftreal1024flat_btn">Do it!</button> <small>(<span id="genflatcode_asmjs_dftreal1024flat_duration">Might last a few seconds</span>)</small></p>

<pre class="pre-scroll prettyprint"><code id="genflatcode_asmjs_dftreal1024flat_output"></code></pre>
<script type="text/javascript">
var dftreal1024flat_asmjsGen;
function genflatcode_asmjs_dftreal1024flat()
{
    // First, make sure flatorize has already been called

    genflatcode_dftreal1024flat();

    // Second, call flatorize.getAsmjsGen

    if (genflatcode_asmjs_dftreal1024flat.called)
        return;
    genflatcode_asmjs_dftreal1024flat.called = true;

    
    var button = document.getElementById( "genflatcode_asmjs_dftreal1024flat_btn" );
    button.setAttribute( "disabled", "disabled" );
  

    var f = new Function( document.getElementById("genflatcode_asmjs_dftreal1024flat_code").textContent + "; return dftreal1024flat_asmjsGen;");


    var t_begin = Date.now();
    
    dftreal1024flat_asmjsGen = f();

    var t_end = Date.now();


    var outnode = document.getElementById( 'genflatcode_asmjs_dftreal1024flat_output' );
    outnode.textContent = "" + dftreal1024flat_asmjsGen;

    write_duration( t_end - t_begin, "genflatcode_asmjs_dftreal1024flat_duration" );

    var works = false;
    try {
        asmjs_dftrealflat_check( 1024 );
        works = passed.asmjs_dftreal1024flat_check;
    } catch (e) {
    }
    if (!works)
        alert( 'DFT1024: bug' );
}
</script>



<p>The generator can be used as follows to compile and use the <code>asm.js</code> code:</p>
<pre class="prettyprint lang-js pre-scroll"><code><span id="asmjs_dftrealflat_check_1024_code">asmjs_dftrealflat_check( 1024 );</span>

<script type="text/javascript">document.write(asmjs_dftrealflat_check);</script></code></pre>














<script type="text/javascript" src="asmjs_remaining_tests.js"></script>


















<h3 class="anchorable" id="performance">Performance (under construction)<a href="#performance" class="anchor">#</a></h3>


<script type="text/javascript">
function xxxperf(dftsize)
{
    (dftsize  ||  null).toPrecision.call.a;

    console.log('dftsize: ' + dftsize);
    var input = new Array(dftsize).join(',').split(',').map( Math.random )
    , N = Math.round( 1e6 * 16 / dftsize )
    ;

    var flatimpl = this[ 'dftreal' + dftsize + 'flat' ].getDirect();
    console.time('flatorized')
    for (var i = N; i--;)
        var output = flatimpl( input );
    console.timeEnd('flatorized')

    // --- Inputs and output
    var dftrealflat_asmjsGen = this[ 'dftreal' + dftsize + 'flat_asmjsGen' ]
    ,   dftrealflat_buffer = 
        new ArrayBuffer( dftrealflat_asmjsGen.buffer_bytes )
    ;

    // --- Compile the asm.js code
    var dftrealflat_asmjsO = dftrealflat_asmjsGen( 
        window, {}, dftrealflat_buffer 
    );

    // --- Example of use

    var      n2i = dftrealflat_asmjsGen.array_name2info
    , TypedArray = dftrealflat_asmjsGen.TypedArray
    
    // Input views

    , arr  = new TypedArray( 
        dftrealflat_buffer, n2i.arr.begin_bytes, n2i.arr.n 
    )
    
    // Output view                                  

    , freq = new TypedArray( 
        dftrealflat_buffer, n2i.freq.begin_bytes, n2i.freq.n 
    )
    ;

    // Write input values
    arr.set( input );

    var asmjsimpl = dftrealflat_asmjsO[ 'dftreal' + dftsize + 'flat' ];

    console.time('flatorized+asm.js');
    for (var i = N; i--;)
        asmjsimpl();
    console.timeEnd('flatorized+asm.js');

}
</script>


<pre>
Firefox on DFT REAL 16:

flatorized: 647.95ms
flatorized+asm.js deactivated (no "use asm"): 130.51ms (fine)
flatorized+asm.js: 364.52ms (fine but lesser than without use asm - probably classical issue when test code NOT in asm.js)

.

Chrome on DFT REAL 16:

flatorized: 556.000ms
flatorized+asm.js deactivated (no "use asm"): 52.000ms (wow!)
flatorized+asm.js: 53.000ms (wow!)

__________

Firefox on DFT REAL 1024:

flatorized: 7535ms
flatorized+asm.js deactivated (no "use asm"): 7238ms (logical)
flatorized+asm.js: 655ms (wow!)

.

Chrome on DFT REAL 1024:

xxxperf(1024);xxxperf(1024);xxxperf(1024);xxxperf(1024);xxxperf(1024);
dftsize: 1024 
flatorized: 4502.000ms 
flatorized+asm.js: 3254.000ms (heating up)
dftsize: 1024 
flatorized: 1292.000ms 
flatorized+asm.js: 442.000ms (wow!)
dftsize: 1024 
flatorized: 1282.000ms 
flatorized+asm.js: 444.000ms (wow!)
dftsize: 1024 
flatorized: 1405.000ms 
flatorized+asm.js: 1305.000ms (what?)
dftsize: 1024 
flatorized: 1280.000ms 
flatorized+asm.js: 441.000ms (wow!)

</pre>

<p>xxx need to expand the tests, and write up this part</p>

<p>Not surprising, and not directly comparable, because output array creation vs. in-place, but still...</p>


<h4>wrapped with array/read-write for direct comparison</h4>

<script type="text/javascript">
function xxxperfwrapped( dftsize )
{
var input = new Array(dftsize).join(',').split(',').map( Math.random )
 , N = Math.round( 1e6 * 16 / dftsize )
;

var flatimpl = dftreal16flat.getDirect();
console.time('flatorized')
for (var i = N; i--;)
    var output = flatimpl( input );
console.timeEnd('flatorized')

   // --- Inputs and output

    var dftrealflat_asmjsGen = this[ 'dftreal' + dftsize + 'flat_asmjsGen' ]
    ,   dftrealflat_buffer = 
        new ArrayBuffer( dftrealflat_asmjsGen.buffer_bytes )
    ;

    // --- Compile the asm.js code
    var dftrealflat_asmjsO = dftrealflat_asmjsGen( 
        window, {}, dftrealflat_buffer 
    );

    // --- Example of use

    var      n2i = dftrealflat_asmjsGen.array_name2info
    , TypedArray = dftrealflat_asmjsGen.TypedArray
    
    // Input views

    , arr  = new TypedArray( 
        dftrealflat_buffer, n2i.arr.begin_bytes, n2i.arr.n 
    )
    
    // Output view                                  

    , freq = new TypedArray( 
        dftrealflat_buffer, n2i.freq.begin_bytes, n2i.freq.n 
    )
    ;

    // Write input values
    var asmjsimpl = dftrealflat_asmjsO[ 'dftreal' + dftsize + 'flat' ];

console.time('flatorized+asm.js');
for (var i = N; i--;)
{
   arr.set( input );  // write
   asmjsimpl();
var output_freq = [].slice.call( output );  // read
}
console.timeEnd('flatorized+asm.js');

}
</script>

<pre>
Firefox

flatorized: 671.75ms
flatorized+asm.js wrapped: 920.15ms  (worse)
-> read/write cost about 920-360=560ms

.

Chrome

flatorized: 525.000ms 
flatorized+asm.js wrapped: 397.000ms    (still better!)
-> read/write cost about 400-50=350ms
</pre>



















<h3 class="anchorable" id="test">Unit tests<a href="#test" class="anchor">#</a></h3>

<p><span class="global-result"></span>.</p>

<p>Detail:</p>
<ul>
<script type="text/javascript">
var passed;
var all_passed;
(function ()
{
    var empty = {};
    all_passed = passed  &&  Object.keys( passed ).map( function (k) { 
        if (k in empty)
            return true;
  
        var pk = passed[ k ];
        document.write( '\x3Cli\x3E\x3Ca href="expl/' + (typeof pk === 'string'  ?  pk  :  k.replace( /^expl_/, '' )) + '.js"\x3E' + k + '\x3C/a\x3E \x3Cspan class="' + (pk  ?  'happy'  :  'sad') + '"\x3E' + (pk  ?  'passed'  :  'failed')+ '.\x3C/span\x3E' +  '\x3C/li\x3E' );
    
        return pk;
    }).every( function (x) { return x; }); 
    
    [].forEach.call( document.getElementsByClassName( 'global-result' ), function ( grnode ) { 
        grnode.innerHTML = all_passed  ?  'ALL TESTS \x3Cspan class="happy"\x3Epassed\x3C/span\x3E'  :  'Some test(s) \x3Cspan class="sad"\x3EFAILED\x3C/span\x3E';
    });
})();
</script>
</ul>
</p>
















<script type="text/javascript" src="contents_ul.js"></script>

<script type="text/javascript" src="prettify/prettify.js"></script>
<script type="text/javascript">setTimeout( prettyPrint );</script>
<script type="text/javascript" src="btn_anchor.js"></script>
<script type="text/javascript" src="../MathJax/MathJax.js?config=default"></script>
<script type="text/javascript" src="ga.js"></script>

</body>
</html>
