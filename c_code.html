<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8" /> 
<title>Flatorize: Generate fast C code</title>
<link rel="stylesheet" type="text/css" href="prettify/prettify.css">
<link rel="stylesheet" type="text/css" href="flatorize.css">
<script type="text/javascript" src="log.js"></script>
<script type="text/javascript" src="flatorize.js"></script>
<script type="text/javascript" src="examples.js"></script>
<script type="text/javascript">generate_small_functions();</script>
<script type="text/javascript" src="flatorize_c.js"></script>
<!--script type="text/javascript" src="examples_c.js"></script-->
</head>
<body>

<a href="https://github.com/glathoud/flatorize" class="print-hidden">
  <img style="position: fixed; top: 0; right: 0; border: 0; margin: 0; padding: 0;"
       src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
       alt="Fork me on GitHub">
</a>

<p><a href="index.html">Back to the main article</a></p>

<h2><code>flatorize-c</code>: Generate fast C code</h2>

<p style="text-align:right">by <a href="http://glat.info">Guillaume Lathoud</a><span class="print">&nbsp;[1]</span>, April 2013</p>

<p>This page presents a plugin method <code>flatorize.getCodeC()</code> (GitHub <a href="https://github.com/glathoud/flatorize/blob/master/flatorize_c.js">source</a>) that goes on top of <code>flatorize</code> (see the <a href="index.html">main article</a>, GitHub <a href="https://github.com/glathoud/flatorize/blob/master/flatorize.js">source</a>).</p>

<p>Several examples describe how to use <code>flatorize.getCodeC()</code> to speedup C code for mathematical expressions.</p>
<ul class="small">
  <li><a href="#c-f2">complex numbers (how-to example)</a></li>
  <li><a href="#c-matmul">matrix multiplication (speedup example)</a><br>
...<code>flatorize-c</code> brings a <a href="https://github.com/glathoud/flatorize/blob/master/explore/C/cAll_matmul.results.txt#L48">+60% speedup</a> over the <a href="https://github.com/glathoud/flatorize/blob/master/explore/C/c_matmul_classic.c#L50">original C code</a>.</li>
  <li><a href="#c-dft">Discrete Fourier Transform (speedup example)</a><br>
...<code>flatorize-c</code>, compiled with just <code>-O3</code>, already brings a <a href="https://github.com/glathoud/flatorize/blob/master/explore/C/cAll_dftreal16.results.txt#L43">+43% speedup</a> over the highly optimized <a href="http://www.fftw.org/fftw-3.3.3.tar.gz">FFTW&nbsp;3.3.3</a>.
</li>
</ul>
  
<p>Application: You can use your browser &ndash; or a V8 engine &ndash; to  quickly generate optimized C code, which you then insert into your C application. Example: the C performance tests conducted here (<a href="https://github.com/glathoud/flatorize/tree/master/explore/C">GitHub source</a>).</p>





<h3 class="anchorable" id="c-f2"><code>f2:</code> complex numbers (how-to example)<a href="#c-f2" class="anchor">#</a></h3>

<p>Expression definition  (details in the <a href="index.html#example">main article</a>):</p>
<pre class="prettyprint lang-js"><code>// f:
<script type="text/javascript">document.write(f2.exprgen+"");</script></code></pre>

<p>A call to <code>flatorize()</code>:</p>
<pre class="prettyprint lang-js"><code>// note the type declarations, ignored by JavaScript but used later for C
f2 = flatorize('a:[2 float],b:[2 float],c:[2 float]->d:[2 float]',f);
</code></pre>

<p>...generates flatorized JavaScript code:</p>
<pre class="prettyprint lang-js"><code>// f2.getDirect():
<script type="text/javascript">document.write(f2.getDirect()+"");</script></code></pre>

<p>Then, a call to <code>flatorize.getCodeC()</code>:</p>
<script type="text/javascript" id="script-gen-f2_c_code">var f2_c_code = flatorize.getCodeC( { switcher: f2, name: "f2" } );</script>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(document.getElementById("script-gen-f2_c_code").textContent);</script></code></pre>

<p>...generates flatorized C code:</p>
<pre class="prettyprint lang-js"><code>// f2_c_code:
<script type="text/javascript">document.write(f2_c_code);</script></code></pre>
<p class="small">(This code, as a few others below, was produced and inserted as you loaded the page.)</p>

<p>Implementation note: JavaScript and C share pretty much the same syntax for mathematical operations, so a good share of the generated JavaScript code is reused here. Only C types, function declarations, casts, and in-place array output have to be dealt with.</p>




<h3 class="anchorable" id="c-matmul"><code>matmul342:</code> matrix multiplication (speedup example)<a href="#c-matmul" class="anchor">#</a></h3>

<p>Task: generate fast C code to multiply a 3x4 matrix with a 4x2 matrix.</p>

<p>A call to <code>flatorize()</code>:</p>
<pre class="prettyprint lang-js"><code>// note the type declarations, ignored by JavaScript but used later for C
matmul342 = flatorize('a:[12 float],b:[8 float]->c:[6 float]',
                      matmul_exprgenF(3,4,2));
</code></pre>

<p>...generates flatorized JavaScript code  (<a href="index.html#matmul">details</a>).</p>

<p>Then, a call to <code>flatorize.getCodeC()</code>:</p>
<script type="text/javascript" id="script-gen-matmul342_c_code">var matmul342_c_code = flatorize.getCodeC( { switcher: matmul342,
                                             name: "matmul342" } );</script>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(document.getElementById("script-gen-matmul342_c_code").textContent);</script></code></pre>

<p>...generates flatorized C code:</p>

<pre class="prettyprint lang-js"><code>// matmul342_c_code
<script type="text/javascript">document.write(matmul342_c_code);</script></code></pre>

<p>...which brings a <a href="https://github.com/glathoud/flatorize/blob/master/explore/C/cAll_matmul.results.txt#L48">+60% speedup</a> over the <a href="https://github.com/glathoud/flatorize/blob/master/explore/C/c_matmul_classic.c#L50">original C code</a>.</p>







<h3 class="anchorable" id="c-dft"><code>dft:</code> Discrete Fourier Transform (speedup example)<a href="#c-dft" class="anchor">#</a></h3>

<script type="text/javascript">generate_dftrealflat( 16 );</script>

<p>A call to <code>flatorize()</code>:</p>
<pre class="prettyprint lang-js"><code>// note the type declarations, ignored by JavaScript but used later for C
dftreal16flat = flatorize('arr:[16 float]->X:[16 [2 float]]',
                          dft_exprgenF( 4, { real: true } ));
</code></pre>

<p>...generates flatorized JavaScript code  (<a href="index.html#dft">details</a>).</p>

<p>Then, a call to <code>flatorize.getCodeC()</code>:</p>
<script type="text/javascript" id="script-gen-dftreal16flat_c_code">var dftreal16flat_c_code = flatorize.getCodeC( { switcher: dftreal16flat,
                                                 name: "dftreal16flat" });</script>
<pre class="prettyprint lang-js"><code><script type="text/javascript">document.write(document.getElementById("script-gen-dftreal16flat_c_code").textContent);</script></code></pre>

<p>...generates flatorized C code:</p>

<pre class="prettyprint lang-js pre-scroll"><code>// dftreal16flat_c_code
<script type="text/javascript">document.write(dftreal16flat_c_code);</script></code></pre>

<p>...which, compiled with just <code>-O3</code>, already brings a <a href="https://github.com/glathoud/flatorize/blob/master/explore/C/cAll_dftreal16.results.txt#L43">+43% speedup</a> over the highly optimized <a href="http://www.fftw.org/fftw-3.3.3.tar.gz">FFTW&nbsp;3.3.3</a>.</p>







<script type="text/javascript" src="prettify/prettify.js"></script>
<script type="text/javascript">setTimeout( prettyPrint );</script>
<script type="text/javascript">
/* xxx
[ 
    'tryit_speed_matmul342', 'tryit_flatorize_dft16', 'tryit_speed_dft16', 'tryit_flatorize_dft1024', 'tryit_speed_dft1024', 'tryit_all'
].forEach(
    function (id) { document.getElementById(id).removeAttribute('disabled'); }
);
*/
window.ontouchstart = function () { Array.prototype.forEach.call( document.getElementsByClassName( "anchor" ), function (node) { node.className = node.className.replace( /\banchor\b/g, '' ); } ); };
</script>
<script type="text/javascript" src="../MathJax/MathJax.js?config=default"></script>
<script type="text/javascript">
var _gaq = _gaq || [];  _gaq.push(['_setAccount', 'UA-5516483-1']);  _gaq.push(['_trackPageview']);  (function() {    var ga = document.createElement('script');    ga.src = ('https:' == document.location.protocol ? 'https://ssl' :         'http://www') + '.google-analytics.com/ga.js';    ga.setAttribute('async', 'true');    document.documentElement.firstChild.appendChild(ga);  })();
</script>

</body>
</html>
